<tr class="order" <% if (
  shipping_status !== 'shipped'
  && Moment(updated_at).isBefore(Moment().subtract(1, 'days'))
  && (typeof support_status === 'undefined' || !support_status.match(/refund/i))
){ %>
  <% if (typeof helpscout_conversations !== 'undefined' && _.some(helpscout_conversations, function(c){
    return Moment(c.modifiedAt).isAfter(Moment().subtract(1, 'days'));
  })){ %>
    style="background-color: #ff6666;"
  <% } else { %>
    style="background-color: #ffe5e5;"
  <% } %>
<% } %> data-id="<%= _id %>">
  <td>
    <p><strong>ORDER #<%= slug %></strong><br><%= Moment(created_at).format('MM/DD/YYYY hh:mm a') %> (<%= Moment(created_at).fromNow() %>)</p>
    <hr>
    <% if (typeof support_status !== 'undefined' && support_status){ %>
      <% if (support_status.match(/refund/i)){ %>
        <p><span class="label label-danger"><%= support_status.toUpperCase() %></span></p>
      <% } else { %>
        <p><span class="label label-info"><%= support_status.toUpperCase() %></span></p>
      <% } %>
    <% } %>
    <% if (shipping_status !== 'shipped'){ %>
      <p><span class="label label-warning">NOT SHIPPED</span></p>
    <% } else { %>
      <p><span class="label label-success">SHIPPED</span></p>
    <% } %>
    <% if (typeof notes !== 'undefined' && notes){ %>
      <hr>
      <p>NOTES: <%= notes.replace(/\n/g, "</p><p>") %></p>
    <% } %>
    <p>
      <hr>
      <a href="/admin/order/<%= slug %>/read" class="btn btn-default">Edit</a>
    </p>
  </td>
  <td>
    <p><strong>BUYER</strong><br>
    <%= buyer.first_name %> <%= buyer.last_name %><br>
    <%= buyer.street %><br>
    <% if (buyer.street_b){ %>
      <%= buyer.street_b %><br>
    <% } %>
    <%= buyer.city %>, <%= Belt.get(_.find((Belt.get(GB, 'localities.' + buyer.country + '.regions') || []), function(r){ return buyer.region === r.shortCode; }), 'name') || buyer.region %>, <%= buyer.country %> <%= buyer.postal_code %><br>
    <%= buyer.email %><br>
    <%= buyer.phone %><br>
    IP: <%= buyer.ip_address %></p>

    <p><strong>RECIPIENT</strong><br>
    <%= recipient.first_name %> <%= recipient.last_name %><br>
    <%= recipient.street %><br>
    <% if (recipient.street_b){ %>
      <%= recipient.street_b %><br>
    <% } %>
    <%= recipient.city %>, <%= Belt.get(_.find((Belt.get(GB, 'localities.' + recipient.country + '.regions') || []), function(r){ return recipient.region === r.shortCode; }), 'name') || recipient.region %>, <%= recipient.country %> <%= recipient.postal_code %><br>
    <%= recipient.phone %></p>
  </td>
  <td>
    <div class="list-group">
    <% if (typeof helpscout_conversations !== 'undefined') _.each(helpscout_conversations.reverse().slice(0, 5), function(v, k){ %>
      <div class="list-group-item <%= v.status !== 'closed' ? 'bg-warning' : '' %>">
        <a href="<%= v.url %>" target="_blank">#<%= v.number %>: <%= v.subject %> (<%= Moment(v.modifiedAt).fromNow() %>)</a>
      </div>
    <% }) %>
    </div>
  </td>
  <td>
    <% _.each(vendor_products, function(v2, k){ %>
      <% if (Instance.vendor_ids[k]){ %>
        <p>
          <span class="label label-info"
            <% if (Belt.get(Instance.vendor_ids[k], 'shopify.access_token')){ %>
              title="Shopify vendor: no manual handling needed."
            <% } else if (Belt.get(Instance.vendor_ids[k], 'woocommerce.consumer_key')){ %>
              title="Woocommerce vendor: email vendor to alert them to order. They have received it in their API, but we need to make sure they have all info needed. Shipping will need to be entered manually."
            <% } else { %>
              title="Manaul vendor: order must be placed manually and shipping notifications must be manually entered."
            <% } %>
          ><%= Instance.vendor_ids[k].name %></span>
        </p>
      <% } %>
      <% _.each(v2, function(v){ %>
        <p>
          <a href="/product/<%= v.source.product.slug %>" target="_blank">
            <%= v.source.product.label.us %> | <%= v.source.product.brands.join(', ') %>
            <br><%= v.product %>
            <br><small>Admin URL: https://wanderset.com/admin/product/<%= v.source.product.slug %></small>
          </a>
        </p>
        <p><%= _.map(v.options, function(v2, k2){ return k2 + ': ' + v2; }).join(', ') %></p>
        <p>QTY: <%= v.quantity %> | UNIT: $<%= Instance.priceString(v.unit_price) %> | TOTAL: $<%= Instance.priceString(v.price) %></p>
        <% if (Belt.get(v, 'source.stock.manual_override')){ %>
          <p>
            <span class="label label-info">MANUAL SOURCING</span>
          </p>
        <% } %>
        <% if (Belt.get(Instance.vendor_ids[k], 'name') === 'Streetammo' && Belt.get(v, 'source.product.source.record.url')){ %>
          <p>
            <a href="<%= Belt.get(v, 'source.product.source.record.url') %>" target="_blank">Streetammo URL</a>
          </p>
        <% } %>
        <p>
          <% if (_.some(shipped_products, function(p){
            return p.toString() === v._id.toString();
          })){ %>
            <span class="label label-success">SHIPPED</span>
          <% } else { %>
            <% if (Moment().subtract(48, 'hours').isAfter(created_at)){ %>
              <span class="label label-danger">NOT SHIPPED FOR OVER 48 HOURS! CONTACT VENDOR!</span>
            <% } else { %>
              <span class="label label-danger">NOT SHIPPED</span>
            <% } %>
          <% } %>
        </p>
        <% if (v.source.order){ %>
          <p>
            <span class="label label-success">Order <%= Belt.get(v, 'source.order.order.name') %> | ID #<%= Belt.get(v, 'source.order.order.id') %></span>
          </p>
        <% } %>
      <% }) %>
      <hr>
    <% }) %>
  </td>
  <td>
    <p><strong>VENDOR ORDERS</strong></p>
    <% _.each(vendor_orders, function(v2, k){ %>
      <% if (Instance.vendor_ids[k]){ %>
        <p>
          <span class="label label-success"><%= Instance.vendor_ids[k].name %></span>
        </p>
      <% } %>
      <% _.each(v2, function(v){ %>
        <p>Order <%= Belt.get(v, 'order.name') %> | ID #<%= Belt.get(v, 'order.id') %></p>
        <p>Total Price $<%= Belt.get(v, 'order.total_price') || Belt.get(v, 'order.total') %></p>
        <% _.each(Belt.get(v, 'order.line_items'), function(i){ %>
          <p><%= i.name %> (SKU #<%= i.sku %>, QTY: <%= i.quantity %>, PRICE: $<%= i.price %>)</p>
        <% }) %>
        <% _.each(Belt.get(v, 'order.fulfillments'), function(f){ %>
          <p>
            <span class="label label-info"><%= Belt.arrayDefalse([f.tracking_company, f.tracking_number]).join(' - ') %></span>
          </p>
        <% }) %>
      <% }) %>
      <hr>
    <% }) %>

    <p><strong>SHIPMENTS</strong></p>
    <% _.each(shipments, function(v2, k){ %>
      <p>
        <% if (Belt.get(v2, 'status')){ %>
          <span class="label label-<%= v2.status.match(/refund/i) ? 'danger' : 'success' %>"><%= Belt.get(v2, 'status.toUpperCase()') %></span><br>
        <% } %>
        <a href="<%= v2.tracking_url %>" target="_blank"><%= v2.carrier %> <%= v2.tracking_number %></a><br>
        SHIPPED: <%= Moment(v2.created_at).format('MM/DD/YYYY') %> (<%= Moment(v2.created_at).fromNow() %>)
      </p>
      <ul>
        <% _.each(v2.products, function(p){ %>
          <% p = _.find(products, function(p2){ return p2._id.toString() === p; }); %>
          <% if (!p) return; %>
          <li><%= Belt.get(p, 'source.product.label.us') %> (<%= p._id %>)</li>
        <% }) %>
      </ul>
      <hr>
    <% }) %>
  </td>
  <td>
    <p><strong>PAYMENT TRANSACTIONS</strong></p>
    <% _.each(transactions, function(v){ %>
      <p>PAID: <strong>$<%= Instance.priceString(v.amount) %></strong>
      <% if (v.status === 'paid'){ %>
        &nbsp;<span class="label label-success">PAID</span>
      <% } else if (v.status === 'refunded'){ %>
        &nbsp;<span class="label label-danger">REFUNDED</span>
      <% } else if (v.status){ %>
        &nbsp;<span class="label label-info"><%= v.status %></span>
      <% } %>
      <br>
      <%= Moment(v.created_at).format('MM/DD/YYYY hh:mm a') %><br>
      REFUNDED: $<%= Instance.priceString(v.amount_refunded || 0) %><br>
      ID: <a target="_blank" href="<%= v.id.match(/^ch/) ? 'https://dashboard.stripe.com/payments/' + v.id : 'https://www.paypal.com/activity/payment/' + v.id %>"><%= v.id %></a><br>
      PAYMENT METHOD: <%= buyer.payment_method %></p>
    <% }) %>
    <hr>

    <p><strong>LINE ITEMS</strong></p>
    <% _.each(line_items, function(v, k){ %>
      <p><% if (v.type){ %><%= v.type.toUpperCase() %>: <% } %><%= v.label %> - $<%= Instance.priceString(v.amount) %></p>
      <hr>
    <% }) %>
  </td>
</tr>
